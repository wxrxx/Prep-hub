<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - PREP HUB</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../css/design-system.css">
    <link rel="stylesheet" href="../../css/pages/dashboard.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../../index.html" class="logo">
                    <span class="logo-icon">üìö</span>
                    <span class="logo-text">PREP HUB</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a>
                <a href="favorites.html" class="nav-item">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</a>
                <a href="profile.html" class="nav-item active">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a>
            </nav>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
                <div class="user-profile">
                    <span class="user-name" id="userName">User</span>
                </div>
            </header>
            <div class="content-card" style="max-width: 600px;">
                <div class="profile-headertext" style="text-align: center; margin-bottom: 2rem;">
                    <div class="avatar-upload-container"
                        style="position: relative; width: 100px; height: 100px; margin: 0 auto; cursor: pointer;">
                        <input type="file" id="avatarInput" hidden accept="image/*">
                        <div id="avatarPreview" class="avatar-circle"
                            style="width: 100px; height: 100px; font-size: 2.5rem; background-size: cover; background-position: center;">
                            US</div>
                        <div class="avatar-overlay"
                            style="position: absolute; bottom: 0; right: 0; background: #0284c7; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                            <span style="font-size: 14px;">üì∑</span>
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: var(--color-gray-500); font-size: 0.9rem;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
                        (Max 500KB)</p>
                </div>

                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="email" class="form-input" readonly disabled
                            style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="phone" class="form-input" placeholder="08x-xxx-xxxx">
                    </div>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                </form>
            </div>
        </main>
    </div>
    <script src="../../js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        if (!auth.isLoggedIn()) window.location.href = '../auth/login.html';

        let currentAvatar = '';

        async function loadProfile() {
            const user = auth.getUser();
            document.getElementById('name').value = user.name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('userName').textContent = user.name || 'User';

            // Load avatar
            if (user.avatar && (user.avatar.startsWith('data:') || user.avatar.startsWith('http'))) {
                const avatarEl = document.getElementById('avatarPreview');
                avatarEl.textContent = '';
                avatarEl.style.backgroundImage = `url('${user.avatar}')`;
                currentAvatar = user.avatar;
            } else {
                document.getElementById('avatarPreview').textContent = user.name ? user.name.substring(0, 2).toUpperCase() : 'US';
            }
        }
        loadProfile();

        // Avatar Upload Logic
        const avatarInput = document.getElementById('avatarInput');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarContainer = document.querySelector('.avatar-upload-container');

        // Allow clicking the container to trigger input
        if (avatarContainer) {
            avatarContainer.addEventListener('click', () => avatarInput.click());
        }

        if (avatarInput) {
            avatarInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // Check size (500KB)
                if (file.size > 500 * 1024) {
                    Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500KB', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (event) {
                    const base64 = event.target.result;

                    // Optimistic UI update
                    avatarPreview.textContent = '';
                    avatarPreview.style.backgroundImage = `url('${base64}')`;
                    currentAvatar = base64;
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;

            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                // Include avatar in update
                await auth.updateProfile({ name, phone, avatar: currentAvatar });

                await Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 1500,
                    showConfirmButton: false
                });

                // Refresh topbar name
                document.getElementById('userName').textContent = name;

            } catch (err) {
                console.error(err);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
            }
        });
    </script>
</body>

</html>